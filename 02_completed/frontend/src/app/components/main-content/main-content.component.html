<!-- Compact chat interface for floating panel -->
<div class="chat-container">
  <!-- Chat header - only show if there's an active conversation -->
  <div class="chat-header" *ngIf="conversationHistory.length > 0">
    <div class="chat-title">
      <mat-icon class="chat-icon">smart_toy</mat-icon>
      <span>{{ summarisedName }}</span>
    </div>
    <div class="header-actions">
      <button mat-icon-button class="dashboard-btn" (click)="navigateToDashboard()" title="Back to Dashboard">
        <mat-icon>dashboard</mat-icon>
      </button>
      <button mat-icon-button class="close-btn" (click)="endSession()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Chat messages area -->
  <div class="chat-messages" #messagesContainer>
    <!-- Welcome message when no conversation -->
    <div class="welcome-message" *ngIf="conversationHistory.length === 0">
      <div class="welcome-header">
        <button mat-icon-button class="dashboard-nav-btn" (click)="navigateToDashboard()" title="Back to Dashboard">
          <mat-icon>dashboard</mat-icon>
        </button>
      </div>
      <mat-icon class="welcome-icon">smart_toy</mat-icon>
      <h4>Banking Assistant</h4>
      <p>Hello {{ loggedInUser }}! How can I help you with your banking needs today?</p>
      
      <!-- Show chat options inline for floating panel -->
      <app-chat-options></app-chat-options>
    </div>

    <!-- Chat options for new conversation - removed duplicate -->

    <!-- Conversation messages -->
    <div class="message-list">
      <div class="message" *ngFor="let conversation of conversationHistory; let last = last" 
           [ngClass]="conversation.sender === 'User' ? 'user-message' : 'assistant-message'"
           #latestMessage>
        
        <!-- User message -->
        <div class="message-bubble user-bubble" *ngIf="conversation.sender === 'User'">
          <div class="user-message-content">
            <div class="message-text">{{ conversation.prompt }}</div>
          </div>
          <div class="user-avatar">
            <img [src]="imagePath" alt="User Avatar" *ngIf="imagePath; else defaultUserIcon">
            <ng-template #defaultUserIcon>
              <mat-icon>person</mat-icon>
            </ng-template>
          </div>
        </div>

        <!-- Assistant message -->
        <div class="message-bubble assistant-bubble" *ngIf="conversation.sender !== 'User'">
          <div class="assistant-avatar">
            <mat-icon>smart_toy</mat-icon>
          </div>
          <div class="message-content">
            <div class="message-text" [innerHTML]="conversation.completion"></div>
            <div class="message-actions">
              <button mat-icon-button class="action-btn" title="Good response">
                <mat-icon>thumb_up</mat-icon>
              </button>
              <button mat-icon-button class="action-btn" title="Poor response">
                <mat-icon>thumb_down</mat-icon>
              </button>
              <button mat-icon-button class="action-btn" title="Debug info" 
                      (click)="toggleDebugInfo(conversation)">
                <mat-icon>info</mat-icon>
              </button>
            </div>
            <div class="agent-tag">{{ conversation.sender || 'Banking Assistant' }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error message -->
    <div class="error-message" *ngIf="errorMessage">
      <mat-icon>error</mat-icon>
      <span>{{ errorMessage }}</span>
    </div>
  </div>

  <!-- Chat input -->
  <div class="chat-input">
    <div class="input-wrapper">
      <input type="text" 
             [(ngModel)]="userInput" 
             (keyup.enter)="handleChatInput()"
             placeholder="Type your message..."
             [maxlength]="maxInputLength"
             class="message-input">
      <button mat-icon-button 
              class="send-btn" 
              (click)="handleChatInput()"
              [disabled]="!userInput.trim() || isLoading">
        <mat-icon>send</mat-icon>
      </button>
    </div>
    <div class="input-hint">{{ userInput.length }}/{{ maxInputLength }}</div>
  </div>
</div>
